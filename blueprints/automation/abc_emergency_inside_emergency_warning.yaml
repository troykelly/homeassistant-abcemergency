blueprint:
  name: ABC Emergency - Inside Emergency Warning Zone
  description: >
    Maximum urgency alert when you are physically inside an Emergency Warning
    (red level) zone. This is the most critical safety automation - it means
    you may be in immediate danger and need to act NOW.
  domain: automation
  source_url: https://github.com/troykelly/homeassistant-abcemergency/blob/main/blueprints/automation/abc_emergency_inside_emergency_warning.yaml
  input:
    inside_emergency_warning_sensor:
      name: Inside Emergency Warning Sensor
      description: >
        The containment binary sensor for Emergency Warning level
        (e.g., binary_sensor.abc_emergency_home_inside_emergency_warning)
      selector:
        entity:
          filter:
            - integration: abcemergency
              domain: binary_sensor
    notify_device:
      name: Notification Device
      description: The mobile device to send critical notifications to
      selector:
        device:
          filter:
            - integration: mobile_app

trigger:
  - platform: state
    entity_id: !input inside_emergency_warning_sensor
    to: "on"

variables:
  sensor_entity: !input inside_emergency_warning_sensor

action:
  # Critical notification
  - device_id: !input notify_device
    domain: mobile_app
    type: notify
    title: "EVACUATE NOW"
    message: >
      You are INSIDE an Emergency Warning zone!

      {% set incidents = state_attr(sensor_entity, 'incidents') %}
      {{ incidents[0].headline if incidents else 'Check ABC Emergency for details' }}
    data:
      priority: critical
      ttl: 0
      channel: alarm_stream
      push:
        sound:
          name: default
          critical: 1
          volume: 1.0
